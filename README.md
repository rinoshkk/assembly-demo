# Demo solution for Assembly Payments

This document gives some brief idea about the solution to automate a golang application deployment on ECS cluster hosted in AWS with two availability zones.

## Overview
There are two parts for this proposed solution:
* Infrastructure provisioning
* Application deployment

CloudFormations templates are being used for Infrastructure provisioning, Docker for creating images and ECR repository for storing images.

## Architecture Diagram

![Architecture Diagram](
(https://github.com/rinoshkk/assembly-demo/blob/master/Assembly_Demo.png)

### Prerequisites

* AWS account with aws cli already configured with aws_access_key_id, aws_secret_access_key and aws_default_region
* S3 bucket with cfn_templates directory copied to the S3 bucket
* IAM user with programatic access to ECR (Elastic Container Repository) for pushing docker images

```
Give examples
```

### Assumptions
* ECR: 069934997449.dkr.ecr.ap-southeast-2.amazonaws.com/assembly_demo:latest
* Running docker on a Linux machine for generating the docker image
* S3 bucket for storing CF templates located at: https://s3-ap-southeast-2.amazonaws.com/cfn_templates/

### Setup

First step is to create an image which can be used for deployment

```
docker build -t assembly_demo -f Dockerfile.build . # Dockerfile.build is located on the GitHub root dir.
docker images #lists the images built
aws ecr get-login --no-include-email #Login to ECR with the output generated by this command.
docker tag assembly_demo:latest 069934997449.dkr.ecr.ap-southeast-2.amazonaws.com/assembly_demo:latest #tag the image
docker push 069934997449.dkr.ecr.ap-southeast-2.amazonaws.com/assembly_demo:latest #push the image to ECR
```

Now our image is ready and deployed on AWS ECR.

Next step is running the cloudformation template to create the infrastructure stack including the ECS cluster.

```
aws cloudformation create-stack --stack-name wordpress --template-url https://s3-ap-southeast-2.amazonaws.com/cfn_templates/go-app-demo.yml
```
This template file has all other required stacks like VPC, ALB, ECS nested inside it.

If all steps are executed correctly, we will have the complete stack ready with the image on ECR deployed on the ECS containers.

## Future Enhancement

Still working on the CodePipeline part to make the whole workflow automated, starting from taking the go application from GitHub repo and make a docker image on the fly and deploy it on ECR through CodeBuild

## Acknowledgments

* ECS reference arch cfn templates
* Codeship blog for creating mult-stage docker image for go
